Участники: Крестьянова Елизавета, Дашкевич Олеся.
# Введение
Данная лабораторная работа нацелена на изучение nginx. В ней было необходимо следовать следующему ТЗ:
1. Должен работать по https c сертификатом
2. Настроить принудительное перенаправление HTTP-запросов (порт 80) на HTTPS (порт 443) для обеспечения безопасного соединения.
3. Использовать alias для создания псевдонимов путей к файлам или каталогам на сервере.
4. Настроить виртуальные хосты для обслуживания нескольких доменных имен на одном сервере.
5. Что угодно еще под требования проекта.
На деле эта работа обернулась в большую развёртку своего домашнего сервера. Мы позволим себе рассказать подробно об этом длительном процессе. Настройка сертификата, перенаправление HTTP-запросов и виртуальные хосты обсуждаются в пункте 2, конфигурация alias и прочих конфигураций файла nginx для конкретного сайта прилагаются в пункте 3.
В ходе выполнения работы мы подняли сайт [cryptids.plida.ru](https://cryptids.plida.ru).
# 1. Создание физического сервера
## Жил да был пыльный Thinkpad...
Однажды старый ноутбук Thinkpad t550p лежал в ящике без дела. Когда-то у него была ОС Windows 10 и им активно пользовались, но затем хозяин перешёл на стационарный мощный компьютер, и ноутбук остался в стороне. 
К счастью, каждому Thinkpad-у в доме айтишника грозит одна и та же учесть: рано или поздно на него поставят Линукс, и наш друг не был исключением. 

Вот ему заменяют жёсткий диск на новый и красивый SSD 512 ГБ:

![alttext](<../../../tree/master/images/Pasted image 20241016013453.png>)

А вот установка Ubuntu server на ноутбук!.. На дисплее 2560х1440... Хм-м-м...
![[Pasted image 20241016013921.png]]
Вот наш сервер и готов, можно закрывать крышку. Его имя - yetti!
<<Вставь сюда пикчу с пингвином на коробке>>
## SSH доступ
...Но мы ведь ничего на него толком не установили. Кактак, куда закрыли?
А мы будем к нему подключаться через ssh с рабочего убунтового ноутбука и устанавливать всё через него. Пока всё это происходит в домашней сети.
Пропишем для удобства в `~/.ssh/config` на рабочем ноутбуке:
```
host yetti
  user root
  hostname айпишник
  ```
Теперь нам не нужно долго вводить `ssh пользователь@айпишник`, мы можем подключаться через `ssh yetti`. Так же в `~/.ssh/authorized_keys` стоит добавить ssh ключ рабочего ноутбука, чтобы подключаться без ввода пароля.
## Wireguard
Мы планируем хранить разные сайты и прочие процессы на сервере yetti в lxc контейнерах. Проблема: к ним не подключиться с рабочего ноутбука просто так. Есть разные варианты как решить эту проблему, например, в `~/.ssh/config` прописать:
```
host howto.yetti
  user root
  proxycommand ssh -q yetti nc -q0 айпишник_контейнера 22
```
где howto.yetti - контейнер на сервере yetti. Это бы пришлось прописывать для каждого контейнера, что неудобно. Проведём туннель wireguard между рабочим ноутбуком и сервером.

Для начала его надо установить на обоих устройствах через команду:
```
apt install wireguard-tools
```
Генерируем и там, и там ключи:
```
wg genkey
```
Теперь нужно создать конфигурационный файл, где мы укажем интерфейсы и пиры.

Для этого на обоих устройствах создаём `/etc/wireguard/yetti.conf` файл. 
В файле рабочего ноутбука указываем следующие строки:

```
[Interface]
Address = 10.100.100.2/32
PrivateKey = приватный.ключ.рабочего.ноутбука
DNS = 10.227.15.1

[Peer]
# yetti
PublicKey = публичный.ключ.сервера.йетти
AllowedIPs = 10.100.100.0/24, 10.227.15.0/24
Endpoint = айпи.сервера.домашней.сети:51820
PersistentKeepalive = 25
```
А в файле сервера:

```
Interface]
Address = 10.100.100.1/24
ListenPort = 51820
PrivateKey = приватный.ключ.сервера.йетти

[Peer]
# plidaptop
PublicKey = публичный.ключ.рабочего.ноутбука
AllowedIPs = 10.100.100.2/32
PersistentKeepalive = 25
```
Поднимаем интерфейсы с обеих сторон:
```
wg-quick up yetti
```
И с сервера запускаем туннель:
```
systemctl enable wg-quick@yetti.service
```
Проверяем туннель через команду `wg`. 
![[Pasted image 20241017143402.png]]
Устройства соединены! Теперь можно с лёгкостью подключаться к контейнерам сервера.
## lxc контейнеры
Мы будем пользоваться контейнерами lxc.
Для этого устанавливаем:  `sudo snap install lxd`
И его инициализируем `lxd init`.
Для запуска контейнера пропишем:
```
lxc launch ubuntu:22.04 cryptids-memes
```
С помощью команды `lxc list` мы можем посмотреть на наши контейнеры. Вот пример списка контейнеров: 
![[Pasted image 20241017144203.png]]
Отлично, можно делать сайт!.. Почти. Уже сейчас можно подключить в контейнере nginx и посмотреть локально сайт `cryptids-memes.yetti`. Но было решено сделать дополнительные пункты.
# 2. Настройка виртуального сервера для проброса айпи
## Зачем нам это?
Так как этот проект создания домашнего сервера не ограничивается заданной лабораторной работой, а будет реально использоваться для будущих сайтов, хотелось бы дать пользователям возможность подключиться к нашим сайтам через Интернет.
Было бы хорошо приобрести отдельный внешний IP-адрес. К сожалению, это не представилось возможным: провайдер дома не предлагает эту услугу.
Придётся проводить доступ через виртуальный сервер.
## Покупка сервера
Было решено приобрести максимально маленький сервер через услуги firstvds. Был выбран виртуальный сервер  "Прогрев" в Москве с ОС Ubuntu 22.04. Ему был назначен IP-адрес 37.230.113.18, его и будем использовать.
Назначаем ему пароль через сайт firstvds, и теперь можем подключаться к нему через консоль.

Дальше мы будем называть этот виртуальный сервер "portal", а физический сервер, напоминаем, "yetti".
## Настройка сервера
Получаем доступ к виртуальному серверу в терминале командой `ssh root@37.230.113.18`. Мы хотим, чтобы виртуальный сервер тоже имел доступ к yetti через туннель wireguard. Проведём для этих серверов такие же действия, что в пункте 1, только в этот раз Portal выступает в роли сервера.
Всё настроили, проверяем:
![[Pasted image 20241017145702.png]]
Теперь мы должны установить nginx на Portal, чтобы можно было настраивать виртуальные хосты. Nginx устанавливается следующей командой:
```
apt install nginx
```
Настроим конфигурационный файл для будущего сайта cryptids-memes.
Для этого в папке `/etc/nginx/sites-enabled` создаём конфигурационный файл cryptids-memes.conf. В блоке server укажем следующие параметры:
```
server {
        server_name cryptids.plida.ru;

        location / {
                resolver 10.227.15.1:53 valid=30s;
                set $proxy_host cryptids-memes.yetti;
                proxy_pass http://$proxy_host;
                include proxy_params;
        }
```
Запросы на сайт cryptids.plida.ru будут передаваться по прокси к cryptids-memes.yetti. 
Настроим также бесплатный сертификат https на portal с помощью Let's Encrypt через инструмент Certbot, автоматически получающий и обновляющий сертификат.
Устанавливаем: ```sudo snap install --classic certbot```, и создаём сертификат на nginx для cryptids.plida.ru с помощью команды `certbot --nginx`:
![[Pasted image 20241019125324.png]]
Конечный файл nginx стал таким:
![[Pasted image 20241019131153.png]]
При переходе на сервер пользователь автоматически перенаправляется на порт 301 с защищённым соединением. 
Не забываем прописывать после изменений:
```
service nginx reload
```
Осталось настроить сайт.
# 3. Поднятие nginx в контейнере
На сервере yetti заходим в контейнер cryptids-memes и добавляем файлы сайта (index.html) в папку /home/prj/project/public. 
В файле /etc/nginx/sites-enabled/default указываем конфигурационный файл nginx:
```
server {
        listen 80;
        add_header x-who cryptids-memes.yetti;
        server_name _;
        index index.php;
        root /home/prj/project/public;
        location /m/ {
          alias /home/prj/project/public/super/secret/directory/memes/;
        }

        location / {
          try_files $uri /index.html index.php;
        }

}
```
 
